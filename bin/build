#!/bin/bash
set -e

# build web
cd src/web

echo $'\n> pwd\n'
pwd

echo $'\n> npm install\n'
npm install

if [ ! "$1" == "--skip-tests" ]; then
    echo $'\n> npm run test-unattended\n'
    npm run test-unattended
else
    echo $'\ntests skipped\n'
fi

echo $'\n> npm run build\n'
npm run build

# remove old build, but keep .gitkeep
rm -rf ../slskd/wwwroot
mkdir ../slskd/wwwroot
touch ../slskd/wwwroot/.gitkeep

# copy new files
echo $'\n> cp -r build/* ../slskd/wwwroot/\n'
cp -r build/* ../slskd/wwwroot/

# build api + web
cd ../slskd

echo $'\n> pwd\n'
pwd

echo $'\n> dotnet build --no-incremental --nologo --configuration Release\n'
dotnet build --no-incremental --nologo --configuration Release

if [ ! "$1" == "--skip-tests" ]; then
    echo $'\n> dotnet test --no-build --verbosity minimal --blame ../../tests/slskd.Tests.Unit'
    dotnet test --no-build --verbosity minimal --blame ../../tests/slskd.Tests.Unit

    echo $'\n> dotnet test --no-build --verbosity minimal --blame ../../tests/slskd.Tests.Integration'
    dotnet test --no-build --verbosity minimal --blame ../../tests/slskd.Tests.Integration
else
    echo $'\ntests skipped\n'
fi

echo $'\nbuild succeded.'