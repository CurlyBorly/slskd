#!/bin/bash
set -e

build=true

while test $# -gt 0; do
  case "$1" in
    --no-build)
      build=false
      shift
      ;;
    --runtime*)
      shift
      runtime=$1
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "$runtime" ]; then
    echo "error: no runtime specified; provide a valid RID (https://docs.microsoft.com/en-us/dotnet/core/rid-catalog)"
    exit 1
fi

if [ "$build" == true ]; then
    echo $'\n> bin/build\n'
    bin/build
else
    echo $'\n build skipped\n'
fi

cd src/slskd
echo $'\n> pwd\n'
pwd

echo $'\n> dotnet publish ... --runtime '$runtime$'\n'
rm -rf dist/$runtime/*
dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    --self-contained \
    --runtime $runtime \
    --output ../../dist/$runtime

echo $'\npublish succeeded.'