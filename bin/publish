#!/bin/bash
set -e

if [ ! "$1" == "--no-build" ]; then
    echo $'\n> bin/build\n'
    bin/build
fi

cd src/slskd
echo $'\n> pwd\n'
pwd

echo $'\n> dotnet publish ... --runtime win-x64\n'
rm -rf dist/win-x64/*
dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    --self-contained \
    --runtime win-x64 \
    --output ../../dist/win-x64

echo $'\n> dotnet publish ... --runtime linux-x64\n'
rm -rf dist/linux-x64/*
dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    --self-contained \
    --runtime linux-x64 \
    --output ../../dist/linux-x64

echo $'\n> dotnet publish ... --runtime linux-arm\n'
rm -rf dist/linux-arm/*
dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    --self-contained \
    --runtime linux-arm \
    --output ../../dist/linux-arm

echo $'\n> dotnet publish ... --runtime osx-x64\n'
rm -rf dist/osx-x64/*
dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    --self-contained \
    --runtime osx-x64 \
    --output ../../dist/osx-x64