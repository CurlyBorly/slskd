#!/bin/bash
set -e

prebuild=true

while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo 'options:'
      echo '-h, --help          show help'
      echo '--no-prebuild       skip build and test'
      echo '--runtime           a valid RID (https://docs.microsoft.com/en-us/dotnet/core/rid-catalog)'
      echo '--version           version for the binary. defaults to current git tag-SHA'
      exit 0
      ;;
    --no-prebuild)
      prebuild=false
      shift
      ;;
    --runtime*)
      shift
      runtime=$1
      shift
      ;;
    --version)
      shift
      version=$1
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ -z "$version" ]; then 
  tag=$(git describe --tags --abbrev=0)
  sha=$(git rev-parse --short HEAD)
  version=$tag-$sha
fi

if [ -z "$runtime" ]; then
    echo "💥  error: no runtime specified; provide a valid RID (https://docs.microsoft.com/en-us/dotnet/core/rid-catalog)"
    exit 1
fi

if [ "$prebuild" == true ]; then
    echo $'\n\t🛠️  bin/build --version '$version$'\n'
    bin/build
else
    echo $'\n\t⏩  pre-build skipped\n'
fi

cd src/slskd
echo $'\n\t📍  '$(pwd)$'\n'

echo $'\n\t🛠️  dotnet publish ... --runtime '$runtime$' -p:Version '$version$'\n'
rm -rf dist/$runtime/*

dotnet publish \
    --configuration Release \
    -p:PublishSingleFile=true \
    -p:ReadyToRun=true \
    -p:PublishTrimmed=true \
    -p:IncludeNativeLibrariesForSelfExtract=true \
    -p:CopyOutputSymbolsToPublishDirectory=false \
    -p:Version=$version \
    --self-contained \
    --runtime $runtime \
    --output ../../dist/$runtime

cd ../../dist/$runtime
echo $'\n\t📍  '$(pwd)$'\n'

echo $'\n\t📦  artifacts:\n'
find .

echo $'\n\t🎉  publish succeeded!\n'